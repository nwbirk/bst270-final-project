---
title: "BST 270 Final Project"
author: "Nick Birk"
date: "1/17/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The aim of the following project is to recreate one table and one figure from the fivethirtyeight article:

["Inside The Political Donation History Of Wealthy Sports Owners"](https://fivethirtyeight.com/features/inside-the-political-donation-history-of-wealthy-sports-owners/)


# Preparation

To proceed with the analysis, we will first need to load any necessary packages and import the dataset from online. If the dataset is available locally, this option will instead be used to import the dataset.

```{r load_package_and_data, message = FALSE}
# Install packages if they are missing, otherwise load
if (!require('tidyverse')) install.packages('tidyverse')
if (!require('ggplot2')) install.packages('ggplot2')
if (!require('RCurl')) install.packages('RCurl')
if (!require('knitr')) install.packages('knitr')

# Import dataset locally, if available
if (file.exists("../data/sports-political-donations.csv")){
    sports <- read.csv("../data/sports-political-donations.csv")
} else {
    # Otherwise, import dataset from raw github file online
   sports_url <- getURL("https://raw.githubusercontent.com/fivethirtyeight/data/master/sports-political-donations/sports-political-donations.csv")
   sports <- read.csv(text = sports_url)
}


```


# Part 1: Figure 1

To begin, we attempt to recreate the first figure that appears in the article, titled "Team owners give largely to the GOP".

```{r first_inspect}
kable(head(sports))
```

From an inspection of the data, one can see that some processing is required to obtain the values needed to reproduce the figure. In particular, we will first need to process the `donate_amount` colunn from a string (including symbols such as $ and ,) to a numeric value.

```{r clean_amount}
# Process the donation amount by removing $ and , symbols
sports$donate_amount <- str_replace(sports$Amount, "\\$", "")
sports$donate_amount <- str_replace(sports$donate_amount, "\\,", "")
# Second line needed for amounts which originally included multiple "," symbols
sports$donate_amount <- str_replace(sports$donate_amount, "\\,", "")
# Convert from character to numeric
sports$donate_amount <- as.numeric(sports$donate_amount)
```

Now that the donation amount has been made numeric (as the column `donate_amount`), we can proceed. To reproduce the figure, we will want to create a summary within each election year and party. We will use the `group_by` function to get the total donations for each party-election year pair. We will then display the table to ensure we have the correct categories.

```{r summarize_fig1}
# Need to summarize by party, year to get figure values
sports_summary <- sports %>% group_by(Election.Year, Party) %>%
  summarize(total_donated = sum(donate_amount))

# We can see from inspecting this summary table that there are some extra categories
kable(sports_summary)
```

We can see from the above that there are some extra political parties that do not appear in the figure itself. Further, it may be helpful to take an additional step to obtain the proportions of donations for the given year, rather than the raw amount. We make these final processing steps below and display the resulting table:

```{r summarize_fig1_more, message = FALSE}
# Create an even smaller summary dataset that includes the proportion
# Calculated as row amount / annual total
sports_annual_totals <- sports_summary %>% group_by(Election.Year) %>%
  summarize(annual_total = sum(total_donated))
# Join these values as new annual total column and then create proportion column
sports_summary <- inner_join(sports_summary, sports_annual_totals)
sports_summary <- sports_summary %>% mutate(donate_prop = total_donated/annual_total) %>% filter(Party %in% c("Republican", "Democrat"))

# Display table for visual inspection
kable(sports_summary)
```

Finally, we see that we have the values needed to recreate the figure, and proceed to do so:

```{r plot_fig1}
# Plot figure 1
# Election Year is made a factor and donate_pop into a value between 0 and 100 for purely aesthetic reasons
sports_summary %>% 
  ggplot(aes(as.factor(Election.Year), round(100*donate_prop), fill = Party)) + geom_bar(stat = "identity") +
  xlab("") + ylab("") + ggtitle("Team owners give largely to the GOP") +
  scale_fill_manual(values = c("blue", "red"))
```

On a visual basis, the values in the plot seem to roughly correspond to the values of each bar in the original article. For completeness, we can also attempt to reproduce the value from the figure caption, stating that "Giants owner Charles Johnson's total contributions make up 32.1% of all republican contributions"

```{r johnson_prop}
# Get the total sum of Republican donations
republican_summary <- sports_summary %>% filter(Party == "Republican")
republican_total <- sum(republican_summary$total_donated)

# Get the total sum of Johnson's donations
johnson_summary <- sports %>% filter(Owner == "Charles Johnson", Party == "Republican")
johnson_total <- sum(johnson_summary$donate_amount)

print(round(100*johnson_total/republican_total, 1))
```

Indeed, the computed percentage matches the reported amount exactly.

# Part 2: Table 2

We now attempt to reproduce the second table that appears in the article, titled "MLB owners have donated the most"

To begin, we will need to summarize the total donations by league and party, rather than year.

```{r, tab2_summary}
# We will reuse the donate_amount variable that we created previously
# Similar summary table needed as before, but split by league instead of year
sports_summary2 <- sports %>% group_by(League, Party) %>%
  summarize(total_donated = sum(donate_amount))

# Display the resulting table
kable(sports_summary2)
```

This initial version of the table reveals that there are some categories which include multiple leagues. To recreate the table exactly from the article, we will need to instead use some indicator that a row contains a certain league. This is made somewhat more challenging than a standard text search due to the presence of "NBA" and "WNBA" as distinct leagues. For our understanding, the different values of "League" are displayed below

```{r, league_summary}
# Display the frequency table of League values
kable(table(sports_summary2$League))
```

We can use these unique values to obtain the corresponding totals from our previous summary table as follows:

```{r, league_party_totals}
# Create vectors of the party total donations for each of the leagues, based on text matching
republican_league_totals <- c(sum(sports_summary2$total_donated[sports_summary2$Party == "Republican" & sports_summary2$League %in% c("MLB", "MLB, NASCAR")]))

print(republican_league_totals)
```

Finally, we can combine this information and compute the total column (by simply summming Republican and Democrat) to obtain the totals.

```{r, display_table2}
# Display the frequency table of League values
kable(table(sports_summary2$League))
```

# Conclusion

Some challenges to reproducibility include the fact that more additional parties are included in the dataset than are reported in the paper. This is somewhat addressed in the figure captions, but it was not immediately clear to me where categories such as "Bipartisan, but mostly Republican" should be included or excluded from the Republican total amounts (and same for Democrat).